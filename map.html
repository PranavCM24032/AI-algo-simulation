<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🎓 Campus Router - Premium Pathfinding</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        :root {
            --bg-dark: #020617;
            --bg-card: rgba(15, 23, 42, 0.85);
            --accent: #38bdf8;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --border-glow: rgba(56, 189, 248, 0.3);
            --path-active: #22c55e;
            --path-checking: #fbbf24;
            --sidebar-space: 320px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: radial-gradient(circle at center, #020617, #000);
            display: flex;
            min-height: 100vh;
            font-family: 'Outfit', sans-serif;
            overflow: hidden;
            color: var(--text-primary);
        }

        svg {
            position: fixed;
            top: 0;
            left: 0;
            width: calc(100vw - var(--sidebar-space));
            height: 100vh;
            cursor: move;
            display: block;
            flex: 1;
            max-width: 100vw;
        }

        .edge {
            fill: none;
            stroke: #64748b;
            stroke-width: 2.5;
            stroke-opacity: 0.5;
            transition: all 0.3s ease;
        }

        .edge-tree {
            stroke: #38bdf8 !important;
            stroke-width: 3 !important;
            stroke-opacity: 0.7 !important;
        }

        .edge-checking {
            stroke: #fbbf24 !important;
            stroke-width: 3 !important;
            stroke-opacity: 0.9 !important;
            filter: none;
        }

        .path-active {
            stroke: #22c55e !important;
            stroke-width: 5px !important;
            stroke-opacity: 1 !important;
            stroke-dasharray: 10 8;
            animation: none;
            stroke-linecap: round;
            fill: none;
            filter: none;
        }

        @keyframes flow {
            from {
                stroke-dashoffset: 24;
            }

            to {
                stroke-dashoffset: 0;
            }
        }

        .edge-label {
            font-size: 12px;
            fill: #94a3b8;
            opacity: 0.8;
            pointer-events: none;
        }

        .node-circle {
            stroke: #0f172a;
            stroke-width: 2.5px;
            opacity: 1;
            /* NO MORE GLASS - SOLID ONLY */
            filter: grayscale(1) brightness(0.8) drop-shadow(0 4px 6px rgba(0, 0, 0, 0.6));
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), filter 0.3s ease;
        }

        /* Snap to color when active */
        .node-checked .node-circle,
        .node-frontier .node-circle,
        .node-current .node-circle {
            filter: grayscale(0) brightness(1) drop-shadow(0 4px 10px rgba(0, 0, 0, 0.5)) !important;
        }

        .node-current .node-circle {
            stroke: #ffffff;
            stroke-width: 3;
            transform: scale(1.15);
        }

        .node-label {
            font-size: 11px;
            font-weight: 700;
            fill: #f8fafc;
            pointer-events: none;
            text-shadow: none;
        }

        .sidebar {
            position: fixed;
            top: 20px;
            right: 20px;
            bottom: 20px;
            width: 280px;
            background: rgba(15, 23, 42, 0.75);
            backdrop-filter: blur(14px);
            border: 1px solid rgba(148, 163, 184, 0.15);
            border-radius: 30px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 14px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            z-index: 100;
            overflow-y: auto;
            max-height: calc(100vh - 40px);
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .sidebar::-webkit-scrollbar {
            width: 0;
            height: 0;
            display: none;
        }

        .sidebar h2 {
            font-size: 24px;
            font-weight: 800;
            line-height: 1.1;
            white-space: nowrap;
            background: linear-gradient(to right, #fff, var(--accent));
            -webkit-background-clip: text;
            background-clip: text;

            -webkit-text-fill-color: transparent;
            margin-bottom: 5px;
        }

        .input-group label {
            font-size: 11px;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
            display: block;
        }

        select {
            width: 100%;
            background: #0f172a;
            border: 1px solid #334155;
            color: #fff;
            padding: 14px;
            border-radius: 12px;
            font-family: inherit;
            outline: none;
            cursor: pointer;
        }

        .btn-primary {
            background: var(--accent);
            color: #020617;
            border: none;
            padding: 18px;
            border-radius: 16px;
            font-weight: 800;
            font-size: 15px;
            text-transform: uppercase;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(56, 189, 248, 0.3);
            transition: all 0.3s;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-3px);
            filter: brightness(1.1);
            box-shadow: 0 12px 25px rgba(56, 189, 248, 0.4);
        }

        .results-card {
            background: rgba(15, 23, 42, 0.5);
            padding: 16px;
            border-radius: 20px;
            border: 1px solid #334155;
            display: none;
            margin-top: 6px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .stat-value {
            color: var(--accent);
            font-weight: 800;
        }

        #liveTrace {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 10px;
            font-size: 11px;
            color: #fbbf24;
            word-break: break-all;
            max-height: 80px;
            overflow-y: auto;
            margin-top: 10px;
        }

        @media (max-width: 900px) {
            body {
                min-height: 100dvh;
                overflow-x: hidden;
                overflow-y: auto;
                flex-direction: column;
            }

            svg {
                position: relative;
                inset: auto;
                right: auto;
                width: 100vw;
                height: 56dvh;
                cursor: grab;
            }

            .sidebar {
                position: relative;
                top: auto;
                right: auto;
                bottom: auto;
                left: auto;
                width: calc(100% - 20px);
                margin: 10px;
                border-radius: 18px;
                padding: 14px;
                max-height: none;
                overflow-y: visible;
                -webkit-overflow-scrolling: touch;
                gap: 10px;
            }

            .sidebar h2 {
                font-size: 18px;
            }

            .results-card {
                margin-top: 6px;
                padding: 12px;
            }

            .stat-item {
                margin-bottom: 8px;
                font-size: 13px;
            }

            .edge-label {
                display: none;
            }

            .btn-primary,
            select {
                padding: 10px;
                border-radius: 10px;
            }

            #liveTrace {
                max-height: 62px;
            }
        }

        @media (max-width: 480px) {
            .sidebar {
                width: calc(100% - 16px);
                margin: 8px;
                padding: 12px;
            }

            .sidebar h2 {
                font-size: 17px;
            }

            .input-group label {
                font-size: 10px;
                margin-bottom: 6px;
            }
        }
    </style>
</head>

<body>
    <div class="sidebar">
        <h2>🎓 Campus Routing</h2>

        <div class="input-group">
            <label>📍 Start Point</label>
            <select id="startNode"></select>
        </div>

        <div class="input-group">
            <label>🎯 Destination</label>
            <select id="goalNode"></select>
        </div>

        <div class="input-group">
            <label>⚙️ Algorithm Engine</label>
            <select id="algoSelect">
                <option value="astar">A* Algorithm</option>
                <option value="ucs">Uniform Cost Search</option>
                <option value="bfs">Breadth-First Search</option>
            </select>
        </div>

        <button class="btn-primary" id="calculateBtn">START</button>

        <div class="results-card" id="results">
            <div id="status-header" style="display: none;">Ready</div>
            <div id="status-sub" style="display: none; color: var(--text-secondary); font-size: 12px; margin-bottom: 20px;">System
                standby</div>

            <div class="stat-item">
                <span>Path Accumulation:</span>
                <span class="stat-value" id="liveGCost">0</span>
            </div>
            <div class="stat-item">
                <span>Expansion Cycle:</span>
                <span class="stat-value" id="expandCount">0</span>
            </div>

            <label style="font-size: 10px; color: var(--text-secondary); margin-top: 15px;">DATA STREAM (ACTIVE
                PATH)</label>
            <div id="liveTrace">—</div>

            <div id="final-summary" style="margin-top: 20px;"></div>
        </div>
    </div>

    <svg id="canvas"></svg>

    <script>
        const SoundEngine = (() => {
            let ctx = null;
            const masterVolume = 0.55;

            const ensureCtx = () => {
                if (!ctx) ctx = new (window.AudioContext || window.webkitAudioContext)();
                return ctx;
            };

            const unlock = async () => {
                const c = ensureCtx();
                if (c.state === "suspended") await c.resume();
            };

            const playTone = (freq, type, duration, gainValue) => {
                const c = ensureCtx();
                if (c.state !== "running") return;
                const osc = c.createOscillator();
                const gain = c.createGain();

                osc.type = type;
                osc.frequency.setValueAtTime(freq, c.currentTime);
                gain.gain.setValueAtTime(Math.max(0.0001, gainValue * masterVolume), c.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.0001, c.currentTime + duration);

                osc.connect(gain);
                gain.connect(c.destination);
                osc.start();
                osc.stop(c.currentTime + duration);
            };

            return {
                unlock,
                click: () => playTone(600, "sine", 0.1, 0.08),
                scan: () => playTone(800 + Math.random() * 200, "sine", 0.05, 0.05),
                walk: () => playTone(150, "sine", 0.05, 0.04),
                success: () => {
                    const notes = [523.25, 659.25, 783.99, 1046.5];
                    notes.forEach((f, i) => setTimeout(() => playTone(f, "triangle", 0.5, 0.1), i * 140));
                },
                fail: () => playTone(220, "sawtooth", 0.2, 0.09)
            };
        })();
    </script>

    <script>
        const graph = {
            nodes: [
                { id: "A", x: 0.15, y: 0.85, color: "#f87171" },
                { id: "AA", x: 0.88, y: 0.60, color: "#2dd4bf" },
                { id: "B", x: 0.25, y: 0.80, color: "#818cf8" },
                { id: "BB", x: 0.85, y: 0.75, color: "#f472b6" },
                { id: "C", x: 0.30, y: 0.65, color: "#fb7185" },
                { id: "CC", x: 0.75, y: 0.70, color: "#fb923c" },
                { id: "D", x: 0.18, y: 0.70, color: "#34d399" },
                { id: "DD", x: 0.65, y: 0.80, color: "#60a5fa" },
                { id: "E", x: 0.35, y: 0.75, color: "#fbbf24" },
                { id: "EE", x: 0.55, y: 0.75, color: "#a3e635" },
                { id: "F", x: 0.65, y: 0.45, color: "#a78bfa" },
                { id: "FF", x: 0.48, y: 0.85, color: "#f87171" },
                { id: "G", x: 0.08, y: 0.75, color: "#2dd4bf" },
                { id: "GG", x: 0.58, y: 0.92, color: "#818cf8" },
                { id: "H", x: 0.25, y: 0.92, color: "#f472b6" },
                { id: "HH", x: 0.75, y: 0.92, color: "#34d399" },
                { id: "I", x: 0.28, y: 0.55, color: "#fb923c" },
                { id: "II", x: 0.92, y: 0.88, color: "#fbbf24" },
                { id: "J", x: 0.15, y: 0.45, color: "#60a5fa" },
                { id: "JJ", x: 0.18, y: 0.30, color: "#a78bfa" },
                { id: "K", x: 0.35, y: 0.42, color: "#a3e635" },
                { id: "KK", x: 0.80, y: 0.32, color: "#2dd4bf" },
                { id: "L", x: 0.12, y: 0.25, color: "#f87171" },
                { id: "LL", x: 0.05, y: 0.55, color: "#f472b6" },
                { id: "M", x: 0.22, y: 0.20, color: "#818cf8" },
                { id: "MM", x: 0.22, y: 0.38, color: "#fb923c" },
                { id: "N", x: 0.32, y: 0.18, color: "#34d399" },
                { id: "NN", x: 0.42, y: 0.10, color: "#60a5fa" },
                { id: "O", x: 0.38, y: 0.25, color: "#fbbf24" },
                { id: "OO", x: 0.68, y: 0.10, color: "#a3e635" },
                { id: "P", x: 0.42, y: 0.48, color: "#a78bfa" },
                { id: "PP", x: 0.78, y: 0.15, color: "#f87171" },
                { id: "Q", x: 0.55, y: 0.35, color: "#2dd4bf" },
                { id: "QQ", x: 0.95, y: 0.22, color: "#818cf8" },
                { id: "R", x: 0.62, y: 0.28, color: "#f472b6" },
                { id: "RR", x: 0.95, y: 0.35, color: "#34d399" },
                { id: "S", x: 0.80, y: 0.50, color: "#fb923c" },
                { id: "SS", x: 0.95, y: 0.68, color: "#fbbf24" },
                { id: "T", x: 0.60, y: 0.60, color: "#60a5fa" },
                { id: "TT", x: 0.82, y: 0.82, color: "#a78bfa" },
                { id: "U", x: 0.48, y: 0.55, color: "#a3e635" },
                { id: "UU", x: 0.72, y: 0.88, color: "#2dd4bf" },
                { id: "V", x: 0.45, y: 0.62, color: "#f87171" },
                { id: "VV", x: 0.48, y: 0.95, color: "#f472b6" },
                { id: "W", x: 0.55, y: 0.20, color: "#818cf8" },
                { id: "WW", x: 0.32, y: 0.95, color: "#fbbf24" },
                { id: "X", x: 0.70, y: 0.25, color: "#34d399" },
                { id: "XX", x: 0.05, y: 0.85, color: "#60a5fa" },
                { id: "Y", x: 0.88, y: 0.22, color: "#fb923c" },
                { id: "YY", x: 0.10, y: 0.65, color: "#a3e635" },
                { id: "Z", x: 0.92, y: 0.50, color: "#a78bfa" },
                { id: "ZZ", x: 0.95, y: 0.10, color: "#f87171" }
            
            ],
            edges: [
                { "from": "A", "to": "B", "weight": 31 },
                { "from": "A", "to": "D", "weight": 24 },
                { "from": "A", "to": "G", "weight": 29 },
                { "from": "A", "to": "XX", "weight": 20 },
                { "from": "AA", "to": "BB", "weight": 14 },
                { "from": "AA", "to": "S", "weight": 15 },
                { "from": "AA", "to": "Z", "weight": 11 },
                { "from": "B", "to": "C", "weight": 25 },
                { "from": "B", "to": "E", "weight": 17 },
                { "from": "B", "to": "H", "weight": 15 },
                { "from": "BB", "to": "CC", "weight": 10 },
                { "from": "BB", "to": "S", "weight": 12 },
                { "from": "C", "to": "D", "weight": 22 },
                { "from": "C", "to": "E", "weight": 12 },
                { "from": "C", "to": "I", "weight": 18 },
                { "from": "C", "to": "V", "weight": 26 },
                { "from": "CC", "to": "DD", "weight": 12 },
                { "from": "CC", "to": "F", "weight": 25 },
                { "from": "CC", "to": "S", "weight": 18 },
                { "from": "CC", "to": "SS", "weight": 20 },
                { "from": "CC", "to": "UU", "weight": 15 },
                { "from": "D", "to": "G", "weight": 20 },
                { "from": "D", "to": "J", "weight": 22 },
                { "from": "D", "to": "YY", "weight": 15 },
                { "from": "DD", "to": "EE", "weight": 15 },
                { "from": "DD", "to": "F", "weight": 35 },
                { "from": "DD", "to": "GG", "weight": 10 },
                { "from": "DD", "to": "T", "weight": 16 },
                { "from": "E", "to": "FF", "weight": 15 },
                { "from": "E", "to": "V", "weight": 11 },
                { "from": "EE", "to": "FF", "weight": 12 },
                { "from": "EE", "to": "T", "weight": 20 },
                { "from": "EE", "to": "U", "weight": 14 },
                { "from": "F", "to": "Q", "weight": 12 },
                { "from": "F", "to": "R", "weight": 15 },
                { "from": "F", "to": "S", "weight": 15 },
                { "from": "F", "to": "T", "weight": 14 },
                { "from": "FF", "to": "GG", "weight": 12 },
                { "from": "FF", "to": "VV", "weight": 14 },
                { "from": "G", "to": "J", "weight": 14 },
                { "from": "G", "to": "XX", "weight": 12 },
                { "from": "G", "to": "YY", "weight": 14 },
                { "from": "GG", "to": "HH", "weight": 14 },
                { "from": "GG", "to": "VV", "weight": 10 },
                { "from": "H", "to": "WW", "weight": 3 },
                { "from": "HH", "to": "II", "weight": 11 },
                { "from": "HH", "to": "UU", "weight": 13 },
                { "from": "I", "to": "J", "weight": 13 },
                { "from": "I", "to": "K", "weight": 15 },
                { "from": "I", "to": "MM", "weight": 12 },
                { "from": "I", "to": "P", "weight": 14 },
                { "from": "II", "to": "SS", "weight": 22 },
                { "from": "II", "to": "TT", "weight": 15 },
                { "from": "J", "to": "L", "weight": 18 },
                { "from": "J", "to": "LL", "weight": 14 },
                { "from": "J", "to": "MM", "weight": 10 },
                { "from": "JJ", "to": "K", "weight": 20 },
                { "from": "JJ", "to": "L", "weight": 14 },
                { "from": "JJ", "to": "M", "weight": 11 },
                { "from": "JJ", "to": "MM", "weight": 9 },
                { "from": "JJ", "to": "N", "weight": 14 },
                { "from": "K", "to": "MM", "weight": 10 },
                { "from": "K", "to": "N", "weight": 58 },
                { "from": "K", "to": "P", "weight": 12 },
                { "from": "KK", "to": "QQ", "weight": 10 },
                { "from": "KK", "to": "S", "weight": 12 },
                { "from": "KK", "to": "X", "weight": 14 },
                { "from": "KK", "to": "Y", "weight": 15 },
                { "from": "L", "to": "M", "weight": 12 },
                { "from": "L", "to": "MM", "weight": 15 },
                { "from": "LL", "to": "XX", "weight": 18 },
                { "from": "LL", "to": "YY", "weight": 10 },
                { "from": "M", "to": "N", "weight": 16 },
                { "from": "M", "to": "NN", "weight": 25 },
                { "from": "N", "to": "O", "weight": 10 },
                { "from": "N", "to": "OO", "weight": 36 },
                { "from": "N", "to": "P", "weight": 20 },
                { "from": "NN", "to": "O", "weight": 15 },
                { "from": "NN", "to": "Q", "weight": 22 },
                { "from": "NN", "to": "W", "weight": 20 },
                { "from": "OO", "to": "PP", "weight": 11 },
                { "from": "OO", "to": "W", "weight": 12 },
                { "from": "OO", "to": "ZZ", "weight": 18 },
                { "from": "P", "to": "Q", "weight": 18 },
                { "from": "P", "to": "U", "weight": 11 },
                { "from": "P", "to": "V", "weight": 15 },
                { "from": "PP", "to": "Y", "weight": 13 },
                { "from": "Q", "to": "R", "weight": 10 },
                { "from": "Q", "to": "T", "weight": 25 },
                { "from": "Q", "to": "U", "weight": 22 },
                { "from": "QQ", "to": "RR", "weight": 15 },
                { "from": "R", "to": "S", "weight": 28 },
                { "from": "R", "to": "X", "weight": 10 },
                { "from": "RR", "to": "S", "weight": 25 },
                { "from": "RR", "to": "Y", "weight": 19 },
                { "from": "S", "to": "Z", "weight": 11 },
                { "from": "SS", "to": "Z", "weight": 25 },
                { "from": "T", "to": "U", "weight": 13 },
                { "from": "T", "to": "V", "weight": 18 },
                { "from": "TT", "to": "UU", "weight": 10 },
                { "from": "U", "to": "V", "weight": 10 },
                { "from": "V", "to": "WW", "weight": 16 },
                { "from": "VV", "to": "WW", "weight": 10 },
                { "from": "X", "to": "Y", "weight": 18 },
                { "from": "Y", "to": "ZZ", "weight": 17 },
                  { "from": "O", "to": "Q", "weight": 17 },
                    { "from": "R", "to": "W", "weight": 17 }
            
            
            
            ]
        };

        const canvas = d3.select("#canvas");
        const defs = canvas.append("defs");

        // Define premium 3D gradients for each node
        graph.nodes.forEach(n => {
            const gradId = `grad-${n.id.replace(/\W/g, '')}`;
            const grad = defs.append("radialGradient")
                .attr("id", gradId)
                .attr("cx", "30%").attr("cy", "30%").attr("r", "70%");

            // Glossy Highlight (Top-left shine)
            grad.append("stop").attr("offset", "0%").attr("stop-color", "#fff").attr("stop-opacity", 0.6);
            // Main Base Color
            grad.append("stop").attr("offset", "45%").attr("stop-color", n.color).attr("stop-opacity", 1);
            // Edge Shadow (Depth)
            grad.append("stop").attr("offset", "100%").attr("stop-color", d3.color(n.color).darker(1.2)).attr("stop-opacity", 1);
        });

        const container = canvas.append("g");
        const zoom = d3.zoom().scaleExtent([0.1, 5]).on("zoom", (e) => container.attr("transform", e.transform));
        canvas.call(zoom);

        function updateCoords() {
            const canvasEl = document.getElementById("canvas");
            const rect = canvasEl.getBoundingClientRect();
            const w = Math.max(320, rect.width || window.innerWidth);
            const h = Math.max(320, rect.height || window.innerHeight);
            const isMobile = window.innerWidth <= 900;
            // Keep circles/labels/icons fully inside the drawable area.
            const padX = isMobile ? 52 : 72;
            const padY = isMobile ? 52 : 72;
            const innerW = Math.max(1, w - padX * 2);
            const innerH = Math.max(1, h - padY * 2);
            graph.nodes.forEach(n => {
                n.screenX = padX + n.x * innerW;
                n.screenY = padY + n.y * innerH;
            });
        }
        updateCoords();

        const sSel = document.getElementById('startNode');
        const gSel = document.getElementById('goalNode');
        graph.nodes.sort((a, b) => a.id.localeCompare(b.id)).forEach(n => {
            sSel.add(new Option(n.id, n.id));
            gSel.add(new Option(n.id, n.id));
        });
        sSel.value = "A"; gSel.value = "ZZ";

        const edgeGroups = container.append("g").selectAll("g")
            .data(graph.edges).enter().append("g");

        const edges = edgeGroups.append("line")
            .attr("class", "edge")
            .attr("x1", d => graph.nodes.find(n => n.id === d.from).screenX)
            .attr("y1", d => graph.nodes.find(n => n.id === d.from).screenY)
            .attr("x2", d => graph.nodes.find(n => n.id === d.to).screenX)
            .attr("y2", d => graph.nodes.find(n => n.id === d.to).screenY);

        const edgeLabels = edgeGroups.append("text").attr("class", "edge-label")
            .attr("x", d => (graph.nodes.find(n => n.id === d.from).screenX + graph.nodes.find(n => n.id === d.to).screenX) / 2)
            .attr("y", d => (graph.nodes.find(n => n.id === d.from).screenY + graph.nodes.find(n => n.id === d.to).screenY) / 2 - 5)
            .attr("text-anchor", "middle").text(d => d.weight);

        const solutionPath = container.append("polyline").attr("class", "solution-path").style("display", "none");

        const nodeGroups = container.append("g").selectAll("g")
            .data(graph.nodes).enter().append("g")
            .attr("class", "node")
            .attr("transform", d => `translate(${d.screenX}, ${d.screenY})`);

        nodeGroups.append("circle").attr("class", "node-circle")
            .attr("r", 20).attr("fill", d => `url(#grad-${d.id.replace(/\W/g, '')})`);

        const iconContainer = nodeGroups.append("image")
            .attr("class", "node-icon")
            .attr("x", -60).attr("y", -60).attr("width", 120).attr("height", 120)
            .style("display", "none");

        nodeGroups.append("text").attr("class", "node-label")
            .attr("text-anchor", "middle").attr("dy", "0.35em").text(d => d.id);

        function syncNodeVisualsWithIcons() {
            nodeGroups.each(function (d) {
                const hasIcon = iconContainer.filter(n => n.id === d.id).style("display") !== "none";
                const group = d3.select(this);
                group.selectAll(".node-circle, .node-label")
                    .style("display", hasIcon ? "none" : "block");
            });
        }

        const travelerGrad = defs.append("radialGradient").attr("id", "traveler-grad");
        travelerGrad.append("stop").attr("offset", "0%").attr("stop-color", "#fff");
        travelerGrad.append("stop").attr("offset", "100%").attr("stop-color", "#fbbf24");

        const traveler = container.append("image")
            .attr("id", "traveler-core")
            .attr("xlink:href", "student.png")
            .attr("width", 80).attr("height", 80)
            .style("display", "none")
            .style("pointer-events", "none");

        const sleep = ms => new Promise(r => setTimeout(r, ms));
        function heuristic(a, b) {
            const nA = graph.nodes.find(n => n.id === a), nB = graph.nodes.find(n => n.id === b);
            return Math.hypot(nA.screenX - nB.screenX, nA.screenY - nB.screenY);
        }

        async function findPath(startId, goalId, algo) {
            // RESET EVERYTHING: Restore all circles and labels first
            nodeGroups.selectAll(".node-circle, .node-label").style("display", "block");
            edges.attr("class", "edge"); nodeGroups.attr("class", "node");
            solutionPath.style("display", "none"); traveler.style("display", "none");
            iconContainer.style("display", "none");

            // Icon initialization
            iconContainer.filter(d => d.id === startId)
                .attr("xlink:href", "student.png")
                .attr("width", 80).attr("height", 80).attr("x", -40).attr("y", -40)
                .style("display", "block");

            iconContainer.filter(d => d.id === goalId)
                .attr("xlink:href", "teacher.png")
                .attr("width", 80).attr("height", 80).attr("x", -40).attr("y", -40)
                .style("display", "block");

            syncNodeVisualsWithIcons();

            document.getElementById('results').style.display = 'block';
            nodeGroups.filter(d => d.id === goalId || d.id === startId).attr("class", "node node-goal");

            let visited = new Set(), parent = new Map(), gScore = new Map();
            graph.nodes.forEach(n => gScore.set(n.id, Infinity));
            gScore.set(startId, 0);

            let openSet = [startId], expanded = 0, bfsQueue = [startId];

            while (true) {
                let current;
                if (algo === 'bfs') {
                    if (bfsQueue.length === 0) break;
                    current = bfsQueue.shift();
                } else {
                    if (openSet.length === 0) break;
                    openSet.sort((a, b) => (algo === 'astar' ? (gScore.get(a) + heuristic(a, goalId)) : gScore.get(a)) - (algo === 'astar' ? (gScore.get(b) + heuristic(b, goalId)) : gScore.get(b)));
                    current = openSet.shift();
                }

                if (visited.has(current)) continue;
                visited.add(current); expanded++;
                SoundEngine.scan();

                document.getElementById('status-header').innerHTML = `Scanning: ${current}`;
                document.getElementById('liveGCost').innerHTML = Math.round(gScore.get(current));
                document.getElementById('expandCount').innerHTML = expanded;

                let path = []; let t = current;
                while (t) { path.unshift(t); t = parent.get(t); }
                document.getElementById('liveTrace').innerHTML = path.join(' > ');

                nodeGroups.classed("node-checked", d => visited.has(d.id))
                    .classed("node-frontier", d => algo === 'bfs' ? bfsQueue.includes(d.id) : openSet.includes(d.id))
                    .classed("node-current", d => d.id === current);

                if (current === goalId) {
                    const finalPath = path, pathCoords = finalPath.map(id => graph.nodes.find(n => n.id === id));
                    const finalPathEdges = new Set();
                    for (let i = 0; i < finalPath.length - 1; i++) {
                        const a = finalPath[i];
                        const b = finalPath[i + 1];
                        finalPathEdges.add([a, b].sort().join("|"));
                    }

                    // Keep blue explored edges, but remove blue from edges that belong to final path.
                    edges.attr("class", function (d) {
                        const key = [d.from, d.to].sort().join("|");
                        if (finalPathEdges.has(key)) return "edge";
                        return d3.select(this).classed("edge-tree") ? "edge edge-tree" : "edge";
                    });

                    // Final Path Drawing (Flowing Green Dash style)
                    solutionPath.attr("points", pathCoords.map(n => `${n.screenX},${n.screenY}`).join(' '))
                        .style("display", "block")
                        .attr("class", "solution-path path-active");

                    document.getElementById('status-header').innerHTML = "Optimal Route Found";

                    traveler.style("display", "block")
                        .attr("x", pathCoords[0].screenX - 60)
                        .attr("y", pathCoords[0].screenY - 60);

                    // Hide original start icon
                    iconContainer.filter(d => d.id === startId).style("display", "none");
                    syncNodeVisualsWithIcons();

                    for (let i = 1; i < pathCoords.length; i++) {
                        SoundEngine.walk();
                        await traveler.transition().duration(400).ease(d3.easeQuadInOut)
                            .attr("x", pathCoords[i].screenX - 60)
                            .attr("y", pathCoords[i].screenY - 60)
                            .end();
                    }

                    // MEETING EVENT
                    const goalIcon = iconContainer.filter(d => d.id === goalId);
                    goalIcon.attr("xlink:href", "student-teacher.png")
                        .transition().duration(600)
                        .attr("width", 120).attr("height", 120).attr("x", -60).attr("y", -60);
                    syncNodeVisualsWithIcons();

                    traveler.style("display", "none");
                    SoundEngine.success();
                    document.getElementById('status-header').innerHTML = "Session Commenced";
                    return;
                }

                const neighbors = graph.edges.filter(e => e.from === current || e.to === current);
                for (const edge of neighbors) {
                    const neighbor = edge.from === current ? edge.to : edge.from;
                    if (visited.has(neighbor)) continue;
                    const tentative = gScore.get(current) + (algo === 'bfs' ? 1 : edge.weight);
                    if (tentative < gScore.get(neighbor)) {
                        parent.set(neighbor, current); gScore.set(neighbor, tentative);
                        if (algo === 'bfs') bfsQueue.push(neighbor); else if (!openSet.includes(neighbor)) openSet.push(neighbor);
                        edges.filter(e => e === edge).attr("class", "edge edge-tree");
                    }
                }
                await sleep(120);
            }
            SoundEngine.fail();
        }

        document.getElementById('calculateBtn').onclick = async () => {
            await SoundEngine.unlock();
            SoundEngine.click();
            document.getElementById('calculateBtn').disabled = true;
            await findPath(sSel.value, gSel.value, document.getElementById('algoSelect').value);
            document.getElementById('calculateBtn').disabled = false;
        };

        window.onresize = () => {
            updateCoords();
            nodeGroups.attr("transform", d => `translate(${d.screenX}, ${d.screenY})`);
            edges.attr("x1", d => graph.nodes.find(n => n.id === d.from).screenX).attr("y1", d => graph.nodes.find(n => n.id === d.from).screenY)
                .attr("x2", d => graph.nodes.find(n => n.id === d.to).screenX).attr("y2", d => graph.nodes.find(n => n.id === d.to).screenY);
            edgeLabels
                .attr("x", d => (graph.nodes.find(n => n.id === d.from).screenX + graph.nodes.find(n => n.id === d.to).screenX) / 2)
                .attr("y", d => (graph.nodes.find(n => n.id === d.from).screenY + graph.nodes.find(n => n.id === d.to).screenY) / 2 - 5);
        };
    </script>
</body>

</html>
